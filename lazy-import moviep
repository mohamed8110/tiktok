import os, re, io, tempfile, time
import numpy as np
import streamlit as st
from PIL import Image, ImageDraw, ImageFont

st.set_page_config(page_title="MNWS TikTok â€” iPad ready", layout="centered")

OUT_DIR = os.path.join(tempfile.gettempdir(), "mnws_output")
os.makedirs(OUT_DIR, exist_ok=True)

def load_font(size: int):
    for fp in [
        "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf",
        "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf",
        "C:/Windows/Fonts/segoeuib.ttf",
        "C:/Windows/Fonts/segoeui.ttf",
        "C:/Windows/Fonts/arialbd.ttf",
        "C:/Windows/Fonts/arial.ttf",
    ]:
        if os.path.isfile(fp):
            try:
                from PIL import ImageFont
                return ImageFont.truetype(fp, size=size)
            except Exception:
                pass
    from PIL import ImageFont as IF
    return IF.load_default()

def hex_to_rgb(h):
    if h and h.startswith("#") and len(h) in (4,7):
        if len(h)==4: h = "#" + "".join([c*2 for c in h[1:]])
        return (int(h[1:3],16), int(h[3:5],16), int(h[5:7],16))
    return (239,239,239)

def wrap_text(draw, text, font, max_width):
    words = text.split()
    lines, cur = [], ""
    for w in words:
        t = (cur + " " + w).strip()
        bbox = draw.textbbox((0,0), t, font=font)
        if bbox[2]-bbox[0] <= max_width or not cur: cur = t
        else: lines.append(cur); cur = w
    if cur: lines.append(cur)
    return lines

def make_title_overlay(W, H, title, desc, font_size=58, txt="#000000",
                       bar="#FFFFFF", opacity=0.85, top=220, padding=24, radius=28):
    from PIL import Image, ImageDraw
    overlay = Image.new("RGBA", (W, H), (0,0,0,0))
    draw = ImageDraw.Draw(overlay)
    f_title = load_font(font_size)
    f_desc  = load_font(max(28, int(font_size*0.55)))

    lines = []
    max_w = int(W*0.9)
    for ln in wrap_text(draw, title, f_title, max_w): lines.append(("t", ln))
    if desc.strip():
        lines.append(("g",""))
        for ln in wrap_text(draw, desc, f_desc, max_w): lines.append(("d", ln))

    heights, widths = [], []
    for kind, ln in lines:
        f = f_title if kind in ("t","g") else f_desc
        bbox = draw.textbbox((0,0), ln, font=f)
        w = bbox[2]-bbox[0]
        h = bbox[3]-bbox[1] if ln else int(font_size*0.35)
        widths.append(w); heights.append(h)

    text_w = max(widths) if widths else 0
    text_h = sum(heights) + (len(lines)-1)*int(font_size*0.25)
    box_w = min(text_w + padding*2, int(W*0.95))
    box_h = text_h + padding*2
    x = (W - box_w)//2
    y = max(0, min(H - box_h, top))

    a = int(255*float(opacity))
    r,g,b = hex_to_rgb(bar)
    draw.rounded_rectangle((x,y,x+box_w,y+box_h), radius=radius, fill=(r,g,b,a))

    ty = y + padding
    for i,(kind, ln) in enumerate(lines):
        f = f_title if kind in ("t","g") else f_desc
        lw = draw.textbbox((0,0), ln, font=f)[2]
        lx = x + (box_w - lw)//2
        if ln: draw.text((lx, ty), ln, font=f, fill=txt)
        ty += heights[i] + int(font_size*0.25)
    return overlay

def caption_from(title, desc):
    base = ["#nieuws","#marokko","#mnws","#tiktoknews","#viral"]
    main = "#" + re.sub(r"[^A-Za-z0-9]+","", title)[:30].lower()
    tags = [main] + base
    return (f"{title}\n{desc}\n\n" if desc.strip() else f"{title}\n\n") + " ".join(tags[:6])

def sanitize(text): 
    text = re.sub(r"[^\w\-]+","_", text.strip())
    return text[:60].strip("_") or f"video_{int(time.time())}"

def render_video(title, desc, *, bg_bytes=None, logo_bytes=None, music_bytes=None,
                 W=1080, H=1920, font_size=58, txt="#000000", bar="#FFFFFF",
                 opacity=0.85, top=220, logo_pos="topleft", logo_w=200,
                 fps=30, duration=30):
    # Lazy import moviepy here
    try:
        from moviepy.editor import ImageClip, AudioFileClip, CompositeVideoClip, afx
    except ModuleNotFoundError:
        st.error("MoviePy is niet geÃ¯nstalleerd. Controleer je requirements en herstart.")
        raise

    from PIL import Image as PILImage

    # achtergrond
    if bg_bytes:
        bg_img = PILImage.open(bg_bytes).convert("RGB")
        bg_tmp = io.BytesIO()
        bg_img.save(bg_tmp, format="PNG")
        bg_tmp.seek(0)
        base = ImageClip(bg_tmp)
    else:
        # effen grijs
        bg = PILImage.new("RGB", (W, H), hex_to_rgb("#EFEFEF"))
        bg_tmp = io.BytesIO()
        bg.save(bg_tmp, format="PNG")
        bg_tmp.seek(0)
        base = ImageClip(bg_tmp)

    scale = max(W/base.w, H/base.h)
    bg_clip = base.resize(scale).crop(x_center=base.w*scale/2, y_center=base.h*scale/2, width=W, height=H).set_duration(duration)

    ov = make_title_overlay(W,H,title,desc,font_size,txt,bar,opacity,top)
    ov_tmp = io.BytesIO()
    PILImage.fromarray(np.array(ov)).save(ov_tmp, format="PNG")
    ov_tmp.seek(0)
    title_clip = ImageClip(ov_tmp).set_duration(duration)

    layers = [bg_clip, title_clip]

    # logo
    if logo_bytes:
        logo_pil = PILImage.open(logo_bytes).convert("RGBA")
        ratio = logo_w / logo_pil.width
        logo_pil = logo_pil.resize((logo_w, int(logo_pil.height*ratio)), PILImage.Resampling.LANCZOS)
        lg_tmp = io.BytesIO()
        logo_pil.save(lg_tmp, format="PNG"); lg_tmp.seek(0)
        logo_clip = ImageClip(lg_tmp).set_duration(duration)
        m = 24
        if logo_pos=="topleft": pos=(m,m)
        elif logo_pos=="topright": pos=(W-logo_pil.width-m, m)
        elif logo_pos=="bottomleft": pos=(m, H-logo_pil.height-m)
        else: pos=(W-logo_pil.width-m, H-logo_pil.height-m)
        layers.append(logo_clip.set_position(pos))

    final = CompositeVideoClip(layers, size=(W,H))

    # audio
    if music_bytes:
        try:
            mus = AudioFileClip(music_bytes)
            mus = mus.subclip(0, min(duration, getattr(mus,"duration",duration)))
            mus = afx.audio_fadein(mus, 0.6)
            mus = afx.audio_fadeout(mus, 0.6)
            final = final.set_audio(mus.volumex(0.5))
        except Exception:
            pass

    out = os.path.join(OUT_DIR, f"{sanitize(title)}.mp4")
    final.write_videofile(out, fps=fps, codec="libx264", audio_codec="aac", threads=4, preset="medium")
    try: final.close()
    except: pass
    return out

# ---------- UI ----------
st.title("ðŸŽ¬ MNWS TikTok â€” 30s + Beschrijving + Batch (iPad ready)")

bg_up   = st.file_uploader("Achtergrond (jpg/png) â€” optioneel", type=["jpg","jpeg","png"])
logo_up = st.file_uploader("Logo (PNG)", type=["png"])
music_up= st.file_uploader("Muziek (mp3) â€” optioneel", type=["mp3"])

st.subheader("ðŸŽ¥ EÃ©n clip")
title = st.text_input("Titel", "Voorbeeldtitel")
desc  = st.text_area("Korte beschrijving", "Korte uitleg of context bij dit nieuws.")
col1,col2 = st.columns(2)
with col1:
    font_size = st.slider("Titel lettergrootte", 36, 96, 58)
    title_color = st.color_picker("Tekstkleur", "#000000")
with col2:
    bar_color = st.color_picker("Balkkleur", "#FFFFFF")
    bar_opacity = st.slider("Balk opaciteit", 0.0, 1.0, 0.85)
top = st.slider("Titel vertical offset (px)", 0, 800, 220)
logo_pos = st.selectbox("Logo positie", ["topleft","topright","bottomleft","bottomright"], index=0)
logo_w   = st.slider("Logo breedte (px)", 80, 400, 200)

if st.button("â–¶ï¸ Render 1 video (30s)"):
    if not title.strip():
        st.error("Titel is verplicht.")
    else:
        try:
            path = render_video(
                title, desc,
                bg_bytes=(io.BytesIO(bg_up.read()) if bg_up else None),
                logo_bytes=(io.BytesIO(logo_up.read()) if logo_up else None),
                music_bytes=(io.BytesIO(music_up.read()) if music_up else None),
                font_size=font_size, txt=title_color, bar=bar_color,
                opacity=bar_opacity, top=top, logo_pos=logo_pos, logo_w=logo_w,
                duration=30
            )
            st.success(f"Klaar: {os.path.basename(path)}")
            with open(path,"rb") as f:
                st.download_button("â¬‡ï¸ Download MP4", f, file_name=os.path.basename(path), mime="video/mp4")
            st.code(f"{title}\n{desc}", language=None)
        except Exception as e:
            st.error(f"Fout: {e}")

st.divider()

st.subheader("ðŸ” Batch (3 artikels)")
c1,c2 = st.columns(2)
with c1:
    t1 = st.text_input("Titel 1", "")
    t2 = st.text_input("Titel 2", "")
    t3 = st.text_input("Titel 3", "")
with c2:
    d1 = st.text_area("Beschrijving 1", "", height=80)
    d2 = st.text_area("Beschrijving 2", "", height=80)
    d3 = st.text_area("Beschrijving 3", "", height=80)

if st.button("ðŸš€ Render 3 videoâ€™s (30s elk)"):
    items = [(t1.strip(), d1.strip()), (t2.strip(), d2.strip()), (t3.strip(), d3.strip())]
    items = [(t,d) for (t,d) in items if t]
    if not items:
        st.error("Vul minstens Ã©Ã©n titel in.")
    else:
        # keep uploaded files in memory to reuse
        bg_mem   = io.BytesIO(bg_up.read()) if bg_up else None
        logo_mem = io.BytesIO(logo_up.read()) if logo_up else None
        music_mem= io.BytesIO(music_up.read()) if music_up else None

        done = []
        for tt,dd in items:
            try:
                path = render_video(
                    tt, dd,
                    bg_bytes=(io.BytesIO(bg_mem.getvalue()) if bg_mem else None),
                    logo_bytes=(io.BytesIO(logo_mem.getvalue()) if logo_mem else None),
                    music_bytes=(io.BytesIO(music_mem.getvalue()) if music_mem else None),
                    font_size=font_size, txt=title_color, bar=bar_color,
                    opacity=bar_opacity, top=top, logo_pos=logo_pos, logo_w=logo_w,
                    duration=30
                )
                done.append(path)
            except Exception as e:
                st.error(f"Fout bij â€œ{tt}â€: {e}")

        if done:
            st.success(f"{len(done)} clips klaar!")
            for p in done:
                with open(p,"rb") as f:
                    st.download_button(f"â¬‡ï¸ {os.path.basename(p)}", f, file_name=os.path.basename(p), mime="video/mp4")
